# Renders an Argo CD repository Secret for each top-level values key that has:
# - a .repoURL field
# - and that repoURL is NOT http:// or https:// (i.e., likely OCI-style without scheme)

# Expected values:
#   global.argoNamespace (defaults to "argocd" if not set)
{{- $root := . -}}
{{- $argoNs := default "argocd" $root.Values.global.argoNamespace -}}

{{- range $name, $cfg := $root.Values -}}
  {{- if kindIs "map" $cfg -}}
    {{- $repoURL := get $cfg "repoURL" -}}
    {{- if $repoURL -}}
      {{- if not (or (hasPrefix "http://" $repoURL) (hasPrefix "https://" $repoURL)) -}}

{{- $slug := $name | lower | replace "_" "-" | replace " " "-" | replace "." "-" | trunc 50 | trimAll "-" -}}

---

apiVersion: v1
kind: Secret
metadata:
  name: {{ printf "argocd-helm-oci-%s" $slug | trunc 63 | trimSuffix "-" }}
  namespace: {{ $argoNs | quote }}
  labels:
    {{- include "tesk-standalone-stack.labels" $root | nindent 4 }}
    argocd.argoproj.io/secret-type: repository
stringData:
  enableOCI: "true"
  name: {{ $name | quote }}
  type: helm
  url: {{ $repoURL | quote }}

---
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}