# Renders an Argo CD repository Secret for each top-level values key that has:
# - a .repoURL field
# - and that repoURL is NOT http:// or https:// (i.e., likely OCI-style without scheme)

# Expected values:
#   global.argoNamespace (defaults to "argocd" if not set)
{{- $argoNs := default "argocd" .Values.global.argoNamespace -}}

{{- range $name, $cfg := .Values -}}
  {{- /* only consider maps */ -}}
  {{- if kindIs "map" $cfg -}}
    {{- $repoURL := get $cfg "repoURL" -}}
    {{- if $repoURL -}}
      {{- /* skip if repoURL starts with http:// or https:// */ -}}
      {{- if not (or (hasPrefix "http://" $repoURL) (hasPrefix "https://" $repoURL)) -}}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ printf "argocd-helm-oci-%s" $name | trunc 63 | trimSuffix "-" }}
  namespace: {{ $argoNs | quote }}
  labels:
    argocd.argoproj.io/secret-type: repository
    {{- include "tesk-standalone-stack.labels" . | nindent 4 }}
stringData:
  enableOCI: "true"
  name: {{ $name | quote }}
  type: helm
  url: {{ $repoURL | quote }}

      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}